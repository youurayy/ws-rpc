!function(){function initWebSocketRPC(WebSocket){var WebSocketRPC=function(url,protocols,connTimeout,reconnDelay){this.url=url;this.protocols=protocols;this.connTimeout=connTimeout||4e3;this.listeners={};this.reconnDelay=reconnDelay||1e3;this.on("message",function(e){try{try{var msg=JSON.parse(e.data)}catch(e){throw new Error("invalid data received")}if(msg.r){var f=(this.__c||{})[msg.r];if(!f)throw new Error("missing callback[4]:"+msg.r);delete this.__c[msg.r];f.apply(null,msg.a);return}if(msg.c){var t=this;msg.a.push(function(){var rmsg={r:msg.c,a:Array.prototype.slice.call(arguments)};if(rmsg.a.length&&(e=a=rmsg.a[0])instanceof Error){rmsg.a[0]={message:e.message,stack:e.stack};for(var p in e)a[p]=e[p]}t.socket.send(JSON.stringify(rmsg))})}this.emit.apply(this,msg.a)}catch(e){this.emit("error",e)}});this.on("open",function(){this.__clearConnectTimeout()});this.on("close",function(){for(var ks=Object.keys(this.__c||{}),i=0;i<ks.length;i++){!function(cb){(process?process.nextTick:setTimeout)(function(){cb(new Error("disconnected"))},0)}(this.__c[ks[i]])}this.__c=null;if(this.socket){for(var i=0;i<wsEvents.length;i++)this.socket["on"+wsEvents[i]]=null;this.socket=null}this.__clearConnectTimeout();if(this.connTimeout!==-1){var t=this;setTimeout(function(){if(this.connTimeout!==-1)t.connect()},t.reconnDelay)}});this.on("error",function(e){if(typeof module!=="undefined"&&e.message&&e.message.indexOf("ECONNREFUSED")!=-1)this.emit("close")});this.connect()};WebSocketRPC.prototype.connect=function(){var t=this;if(this.socket)if(this.connTimeout!==-1)return this.disconnect();else this.disconnect();if(this.connTimeout!==-1){this.connTimer=setTimeout(function(){if(t.socket.readyState!==WebSocket.OPEN){t.__clearConnectTimeout();t.disconnect()}},this.connTimeout)}this.socket=new WebSocket(this.url,this.protocols);for(var i=0;i<wsEvents.length;i++)this.socket["on"+wsEvents[i]]=function(event){return function(){t.__dispatch(event,arguments)}}(wsEvents[i])};WebSocketRPC.prototype.disconnect=function(noreconnect){if(!this.socket)return;if(noreconnect)this.connTimeout=-1;try{this.socket.close()}catch(e){this.emit("error",e)}};WebSocketRPC.prototype.message=function(){var last=arguments.length-1;var msg={};if(typeof arguments[last]==="function"){if(!this.__c)this.__c={};do{msg.c=randomId()}while(this.__c[msg.c]);this.__c[msg.c]=arguments[last--]}msg.a=Array.prototype.slice.call(arguments,0,last+1);this.socket.send(JSON.stringify(msg))};WebSocketRPC.prototype.on=function(event,listener){this.listeners[event]=this.listeners[event]||[];this.listeners[event].push(listener)};WebSocketRPC.prototype.removeListener=function(event,listener){if(event in this.listeners===false)return;this.listeners[event].splice(this.listeners[event].indexOf(fct),1)};WebSocketRPC.prototype.emit=function(event){if(event in this.listeners===false)return;for(var i=0,l=this.listeners[event],ln=l.length;i<ln;i++)l[i].apply(this,Array.prototype.slice.call(arguments,1))};WebSocketRPC.prototype.__clearConnectTimeout=function(){if(this.connTimer){clearTimeout(this.connTimer);delete this.connTimer}};WebSocketRPC.prototype.__dispatch=function(event,args){var arr=Array.prototype.slice.call(args);arr.unshift(event);this.emit.apply(this,arr)};function randomId(){for(var id="",i=0,f=Math.floor,r=Math.random,s=String.fromCharCode;i<8;i++)id+=s(f(r()*26)+(f(r()*2)?97:65));return id}var wsEvents=["open","error","close","message"];return WebSocketRPC}if(typeof module!=="undefined")module.exports=initWebSocketRPC;else window.InitWebSocketRPC=initWebSocketRPC}();